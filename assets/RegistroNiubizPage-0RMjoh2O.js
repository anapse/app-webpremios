import{a as f,j as e}from"./index-BcMqhxv5.js";import{b as p}from"./vendor-DJKrsZSW.js";import{d as P}from"./RegistroInfo-CLtfe4US.js";import{u as S}from"./useFetch-B8Cb0pGo.js";import{E as I}from"./pdf-C1-dEYVs.js";const D=()=>{const{data:l,loading:j,error:x}=S(f.proximoSorteo),[a,N]=p.useState(null);return p.useEffect(()=>{l&&l.ticket_price!==void 0&&N(l.ticket_price)},[l]),e.jsxs("section",{className:"registro-info",children:[e.jsx("h2",{children:"¿Cómo Participar?"}),e.jsxs("p",{className:"paso",children:["📝 ",e.jsx("strong",{children:"PASO 1:"})," Completa tus datos en el formulario de abajo (DNI o Carnet de Extranjería)."]}),e.jsxs("p",{className:"paso",children:["💳 ",e.jsx("strong",{children:"PASO 2:"})," Haz clic en ",e.jsx("strong",{children:"Registrar Ticket"})," para iniciar el proceso de pago seguro con Niubiz."]}),e.jsxs("p",{className:"detalle",children:["� Se generará un ",e.jsx("strong",{children:"código QR de Yape"})," que debes escanear con tu app Yape para completar el pago."]}),e.jsxs("p",{className:"paso",children:["🎫 ",e.jsx("strong",{children:"PASO 3:"})," Una vez confirmado el pago, tu ticket se generará automáticamente."]}),e.jsxs("div",{className:"detalle",children:[e.jsxs("p",{children:["✅ Verás tu ",e.jsx("strong",{children:"código de ticket único"})," en pantalla."]}),e.jsxs("p",{children:["📄 Podrás ",e.jsx("strong",{children:"descargarlo como PDF"})," para conservarlo."]}),e.jsxs("p",{children:["🔍 También podrás ",e.jsx("strong",{children:"buscar tus tickets"}),' en la sección "Mis Tickets".']})]}),e.jsx("p",{className:"costo",children:"🎟️ Costo del ticket"}),e.jsx("p",{className:"precio",children:e.jsx("strong",{children:j?"Cargando...":x?"Error al cargar":`S/ ${a}`})}),e.jsx("p",{className:"paso2",children:"🎉 ¡Ya estarás participando en el próximo sorteo!"}),e.jsx("div",{className:"flecha",children:e.jsx("strong",{children:"👇"})})]})},A=()=>{const{data:l}=S(f.proximoSorteo),[j,x]=p.useState({days:0,hours:0,mins:0,secs:0}),[a,N]=p.useState({dni:"",nombres:"",apellidos:"",telefono:"",departamento:"",mayorEdad:!1}),[b,E]=p.useState(null),[m,u]=p.useState(null),[k,d]=p.useState(!1),[y,c]=p.useState("");p.useEffect(()=>{if(!l?.sorteo_date)return;const r=new Date(l.sorteo_date),t=setInterval(()=>{const o=r-new Date;if(o<=0)return clearInterval(t),x({days:0,hours:0,mins:0,secs:0});const n=Math.floor(o/864e5),s=Math.floor(o/36e5%24),i=Math.floor(o/6e4%60),g=Math.floor(o/1e3%60);x({days:n,hours:s,mins:i,secs:g})},1e3);return()=>clearInterval(t)},[l]);const h=r=>{const{name:t,value:o,type:n,checked:s}=r.target;N(i=>({...i,[t]:n==="checkbox"?s:o}))},w=async r=>{if(r.preventDefault(),c(""),console.log("[UI] submit"),!a.mayorEdad)return alert("Debes confirmar que eres mayor de edad.");try{d(!0),console.log("[API] POST niubiz/session - Botón de Pago Web");const t=await fetch(f.niubizSession,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({amount:l?.ticket_price??15,currency:"PEN",customer:{dni:a.dni,email:`${a.dni}@gameztore.com`,telefono:a.telefono,ciudad:a.departamento||"Lima",direccion:"Av Jose Pardo 831",codigoPostal:"15074"}})}),o=await t.text();let n={};try{n=JSON.parse(o)}catch{}if(console.log("[API] status",t.status,"body:",n||o),!t.ok){c(n?.error||`Error create (${t.status})`),d(!1);return}if(!n?.sessionKey&&!n?.testMode){c("Respuesta inesperada de create (sin sessionKey)"),d(!1);return}if(n.testMode&&!n.sessionKey){console.log("🧪 MODO DE PRUEBA ACTIVADO - Sin credenciales reales de Niubiz"),u({purchaseNumber:Date.now().toString().slice(-10),transactionId:`TEST-${Date.now()}`,testMode:!0,sessionData:n,reason:"Credenciales de test"}),setTimeout(()=>{console.log("🎭 Simulando autorización automática..."),C(`TEST-${Date.now()}`,Date.now().toString().slice(-10))},4e3);return}if(n.sessionKey){console.log("✅ SessionKey real obtenida, intentando checkout real de Niubiz");try{await v();const s=Date.now().toString().slice(-10);u({sessionKey:n.sessionKey,merchantId:n.merchantId,purchaseNumber:s,amount:n.amount,expirationTime:n.expirationTime}),z(n,s)}catch(s){console.error("❌ Error cargando librería de Niubiz:",s),c("No se pudo cargar el checkout de Niubiz. Verifique que esté en HTTPS o contacte soporte."),d(!1);return}return}}catch(t){console.error("[API] create error",t),c(t.message||"Error iniciando el pago")}finally{d(!1)}},v=()=>new Promise((r,t)=>{const o="https://static-content-qas.vnforapps.com/env/sandbox/js/checkout.js";if(console.log("📦 Cargando script oficial de Niubiz:",o),window.VisanetCheckout&&typeof window.VisanetCheckout.configure=="function"){console.log("✅ VisanetCheckout ya está cargado"),r();return}document.querySelectorAll('script[src*="checkout"], script[src*="payform"], script[src*="vnforapps"]').forEach(i=>{i.remove(),console.log("🧹 Script anterior eliminado:",i.src)});const s=document.createElement("script");s.src=o,s.async=!0,s.onload=()=>{console.log(`✅ Script cargado desde: ${o}`),setTimeout(()=>{window.VisanetCheckout&&typeof window.VisanetCheckout.configure=="function"?(console.log("✅ window.VisanetCheckout disponible"),r()):(console.error("❌ window.VisanetCheckout no disponible después de la carga"),t(new Error("VisanetCheckout no disponible después de cargar la librería")))},1e3)},s.onerror=i=>{console.error(`❌ Error cargando desde ${o}:`,i),t(new Error(`Error cargando librería de Niubiz desde ${o}`))},document.head.appendChild(s),setTimeout(()=>{window.VisanetCheckout||(console.error("⏰ Timeout cargando librería de Niubiz"),t(new Error("Timeout cargando librería de Niubiz")))},1e4)}),z=(r,t)=>{console.log("🔧 Configurando Niubiz Checkout...");try{if(!window.VisanetCheckout)throw new Error("VisanetCheckout no está disponible");if(typeof window.VisanetCheckout.configure!="function")throw new Error("VisanetCheckout.configure no es una función");const o={action:"pay",merchantid:r.merchantId,sessiontoken:r.sessionKey,purchasenumber:t,amount:parseFloat(r.amount),currency:"PEN",channel:"web",expirationminutes:15,timeouturl:"https://anapse.github.io/app-webpremios/#/niubiz"};if(!/^\d+$/.test(t))throw new Error("purchaseNumber debe contener solo números");if(t.length>12)throw new Error("purchaseNumber no puede tener más de 12 dígitos");if(isNaN(o.amount)||o.amount<=0)throw new Error("amount debe ser un número positivo");console.log("📋 Validando parámetros obligatorios:"),console.log("  action:",o.action,"(obligatorio)"),console.log("  merchantid:",o.merchantid,"(obligatorio)"),console.log("  sessiontoken:",o.sessiontoken?`${o.sessiontoken.substring(0,10)}...`:"MISSING","(obligatorio)"),console.log("  purchasenumber:",o.purchasenumber,`(obligatorio, longitud: ${o.purchasenumber.length})`),console.log("  amount:",o.amount,`(obligatorio, tipo: ${typeof o.amount})`),console.log("  timeouturl:",o.timeouturl,"(obligatorio)"),console.log("  currency:",o.currency),console.log("  channel:",o.channel),console.log("  expirationminutes:",o.expirationminutes);const n=["action","merchantid","sessiontoken","purchasenumber","amount","timeouturl"];for(const s of n)if(!o[s]||o[s]===void 0||o[s]==="")throw new Error(`Parámetro obligatorio faltante o vacío: ${s}`);console.log("✅ Todos los parámetros obligatorios están presentes"),window.VisanetCheckout.configure({...o,complete:function(s){console.log("✅ Checkout completado desde Niubiz:",s),d(!1);const i=s?.transactionToken||s?.tokenId;if(!i){console.error("❌ No se recibió token del checkout de Niubiz"),c("No se recibió token de transacción del checkout. Intente nuevamente."),u(null);return}console.log("🔑 Token real recibido:",i),C(i,t)},error:function(s){console.error("❌ Error en el pago desde Niubiz:",s),c(`Error en el proceso de pago: ${s.errorMessage||s.message||"Intenta nuevamente"}`),u(null),d(!1)},close:function(){console.log("ℹ️ Checkout cerrado por el usuario"),u(null),d(!1)}}),console.log("✅ VisanetCheckout.configure() ejecutado exitosamente"),console.log("📱 Abriendo checkout real de Niubiz..."),setTimeout(()=>{try{window.VisanetCheckout.open(),console.log("✅ VisanetCheckout.open() ejecutado")}catch(s){console.error("❌ Error al abrir checkout:",s),c(`Error al abrir el checkout: ${s.message}`),d(!1)}},100)}catch(o){console.error("❌ Error configurando checkout:",o),c(`Error inicializando el checkout de Niubiz: ${o.message}`),u(null),d(!1)}},C=async(r,t)=>{try{console.log("🔐 Autorizando transacción con token REAL..."),console.log("📝 Datos de autorización:",{transactionToken:r,purchaseNumber:t,amount:l?.ticket_price??15});const n=await(await fetch(f.niubizConfirm,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({tokenId:r,purchaseNumber:t,amount:l?.ticket_price??15,currency:"PEN"})})).json();console.log("✅ Respuesta de autorización:",n);const s=n?.dataMap?.ACTION_CODE||n?.actionCode;if(n?.testMode||s==="000"){console.log("🎉 Pago APROBADO con código:",s);const i=await fetch(f.tickets,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({...a,token_yape:n.dataMap?.TRANSACTION_ID||r,id_transaccion:n.dataMap?.TRANSACTION_ID||r,estado_pago:"pagado"})}),g=await i.json().catch(()=>({}));console.log("[TICKET] status",i.status,g),i.ok?(E(g.codigo_ticket),u(null)):c(g?.error||"No se pudo registrar el ticket")}else console.error("❌ Pago RECHAZADO con código:",s),c(`Pago no autorizado (código: ${s}). Intenta nuevamente.`),u(null)}catch(o){console.error("❌ Error en autorización:",o),c("Error procesando el pago. Intenta nuevamente."),u(null)}},T=()=>{const r=new I;r.setFontSize(16),r.text("🎫 Ticket Game Ztore",20,30),r.setFontSize(12),r.text(`Nombre: ${a.nombres} ${a.apellidos}`,20,45),r.text(`DNI: ${a.dni}`,20,55),r.text(`Teléfono: ${a.telefono}`,20,65),r.text(`Departamento: ${a.departamento}`,20,75),r.text(`Código de Ticket: ${b}`,20,85),r.text(`Fecha: ${new Date().toLocaleDateString()}`,20,95),r.save(`${b}.pdf`)};return e.jsx("section",{className:"registro-form",children:e.jsxs("div",{className:"form-container",children:[e.jsx("h2",{children:"Registro de Ticket"}),m?.testMode&&e.jsxs("div",{style:{background:"linear-gradient(135deg, #ff7e00 0%, #e06f00 100%)",border:"2px solid #ff7e00",borderRadius:"12px",padding:"15px",marginBottom:"20px",color:"#1f1f1d",fontWeight:"bold"},children:[e.jsx("strong",{children:"🧪 MODO DE PRUEBA NIUBIZ"}),m.fallbackMode&&e.jsxs(e.Fragment,{children:[e.jsx("br",{}),e.jsx("strong",{children:"⚠️ MODO FALLBACK"})]}),e.jsx("br",{}),e.jsx("small",{style:{color:"#1f1f1d",opacity:"0.8"},children:m.reason==="Credenciales de test"?"Simulación de pago - Configurar credenciales reales para checkout verdadero":m.fallbackMode?"Simulación por error de librería - Verificar conectividad":"Modo de prueba activo"})]}),y&&e.jsx("div",{className:"error",style:{marginBottom:10,color:"#ff6b6b"},children:y}),b?e.jsxs("div",{className:"resultado-ticket",children:[e.jsx("p",{children:"🎉 ¡Gracias por tu compra!"}),e.jsx("p",{children:"Tu número de ticket es:"}),e.jsx("h3",{children:b}),e.jsx("button",{onClick:T,children:"Descargar ticket en PDF"})]}):m?e.jsx("div",{className:"pago-niubiz",children:m.testMode?e.jsxs(e.Fragment,{children:[e.jsxs("p",{children:["🧪 ",e.jsx("strong",{children:"MODO DE PRUEBA NIUBIZ - MEJORADO"})]}),e.jsx("p",{children:"Simulando proceso de pago con Niubiz Sandbox"}),e.jsxs("div",{className:"niubiz-mock-container processing",children:[e.jsx("div",{className:"test-mode-badge",children:"TEST"}),e.jsxs("div",{className:"niubiz-mock-content",children:[e.jsx("div",{className:"icon",children:"💳"}),e.jsx("div",{className:"title",children:"Botón de Pago Web"}),e.jsx("div",{className:"subtitle",children:"Niubiz Sandbox - Incluye Yape"})]})]}),e.jsxs("div",{className:"payment-status",children:[e.jsxs("p",{children:[e.jsx("span",{className:"loading-spinner"}),"Procesando pago automáticamente..."]}),e.jsx("p",{className:"timer",children:"⏱️ Aprobación en 4 segundos"}),e.jsx("p",{className:"info-text",children:"💡 En producción (HTTPS) se abrirá el formulario web real de Niubiz con Yape"})]})]}):e.jsxs("div",{className:"niubiz-processing",children:[e.jsxs("p",{children:["💳 ",e.jsx("strong",{children:"PROCESANDO PAGO CON NIUBIZ"})]}),e.jsx("p",{children:"Se ha abierto el formulario de pago seguro de Niubiz"}),e.jsxs("div",{className:"payment-status",children:[e.jsxs("p",{children:[e.jsx("span",{className:"loading-spinner"}),"Esperando confirmación..."]}),e.jsx("p",{style:{fontSize:"14px",opacity:"0.8"},children:"Complete el pago en la ventana emergente de Niubiz"}),e.jsx("p",{style:{fontSize:"12px",opacity:"0.6"},children:"💳 Métodos disponibles: Tarjetas Visa/MasterCard, Yape"})]})]})}):e.jsxs("form",{onSubmit:w,children:[e.jsx("input",{name:"dni",placeholder:"DNI o C. de Extranjería",value:a.dni,onChange:h,required:!0}),e.jsx("input",{name:"nombres",placeholder:"Nombres",value:a.nombres,onChange:h,required:!0}),e.jsx("input",{name:"apellidos",placeholder:"Apellidos",value:a.apellidos,onChange:h,required:!0}),e.jsx("input",{name:"telefono",placeholder:"Número WhatsApp",value:a.telefono,onChange:h,required:!0}),e.jsxs("select",{name:"departamento",value:a.departamento,onChange:h,required:!0,children:[e.jsx("option",{value:"",children:"Selecciona Departamento"}),P.map(r=>e.jsx("option",{value:r,children:r},r))]}),e.jsxs("label",{className:"checkbox-label",children:[e.jsx("input",{type:"checkbox",name:"mayorEdad",checked:a.mayorEdad,onChange:h}),"Confirmo que soy mayor de edad"]}),e.jsx("button",{type:"submit",className:"btn-yape",disabled:k,children:k?"Iniciando pago seguro...":"Pagar con Niubiz (incluye Yape)"})]}),e.jsx("div",{className:"contador",children:["days","hours","mins","secs"].map(r=>e.jsxs("div",{className:"unidad",children:[e.jsx("div",{className:"numero",children:String(j[r]).padStart(2,"0")}),e.jsx("div",{className:"texto",children:r==="days"?"Días":r==="hours"?"Horas":r==="mins"?"Minutos":"Segundos"})]},r))})]})})},_=()=>e.jsxs("main",{className:"registro-page",children:[e.jsx(D,{}),e.jsx(A,{})]});export{_ as default};
