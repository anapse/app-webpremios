import{a as f,j as e}from"./index-CvijiwMU.js";import{b as d}from"./vendor-DJKrsZSW.js";import{d as A}from"./RegistroInfo-CLtfe4US.js";import{u as I}from"./useFetch-B8Cb0pGo.js";import{E as R}from"./pdf-C1-dEYVs.js";const M=()=>{const{data:l,loading:N,error:b}=I(f.proximoSorteo),[i,j]=d.useState(null);return d.useEffect(()=>{l&&l.ticket_price!==void 0&&j(l.ticket_price)},[l]),e.jsxs("section",{className:"registro-info",children:[e.jsx("h2",{children:"¬øC√≥mo Participar?"}),e.jsxs("p",{className:"paso",children:["üìù ",e.jsx("strong",{children:"PASO 1:"})," Completa tus datos en el formulario de abajo (DNI o Carnet de Extranjer√≠a)."]}),e.jsxs("p",{className:"paso",children:["üí≥ ",e.jsx("strong",{children:"PASO 2:"})," Haz clic en ",e.jsx("strong",{children:"Registrar Ticket"})," para iniciar el proceso de pago seguro con Niubiz."]}),e.jsxs("p",{className:"detalle",children:["ÔøΩ Se generar√° un ",e.jsx("strong",{children:"c√≥digo QR de Yape"})," que debes escanear con tu app Yape para completar el pago."]}),e.jsxs("p",{className:"paso",children:["üé´ ",e.jsx("strong",{children:"PASO 3:"})," Una vez confirmado el pago, tu ticket se generar√° autom√°ticamente."]}),e.jsxs("div",{className:"detalle",children:[e.jsxs("p",{children:["‚úÖ Ver√°s tu ",e.jsx("strong",{children:"c√≥digo de ticket √∫nico"})," en pantalla."]}),e.jsxs("p",{children:["üìÑ Podr√°s ",e.jsx("strong",{children:"descargarlo como PDF"})," para conservarlo."]}),e.jsxs("p",{children:["üîç Tambi√©n podr√°s ",e.jsx("strong",{children:"buscar tus tickets"}),' en la secci√≥n "Mis Tickets".']})]}),e.jsx("p",{className:"costo",children:"üéüÔ∏è Costo del ticket"}),e.jsx("p",{className:"precio",children:e.jsx("strong",{children:N?"Cargando...":b?"Error al cargar":`S/ ${i}`})}),e.jsx("p",{className:"paso2",children:"üéâ ¬°Ya estar√°s participando en el pr√≥ximo sorteo!"}),e.jsx("div",{className:"flecha",children:e.jsx("strong",{children:"üëá"})})]})},$=()=>{const{data:l}=I(f.proximoSorteo),[N,b]=d.useState({days:0,hours:0,mins:0,secs:0}),[i,j]=d.useState({dni:"",nombres:"",apellidos:"",telefono:"",departamento:"",mayorEdad:!1}),[P,y]=d.useState({numeroPedido:"",fechaHoraPedido:"",descripcionDenegacion:"",ipUsuario:""}),[x,D]=d.useState(null),[u,m]=d.useState(null),[k,p]=d.useState(!1),[E,c]=d.useState("");d.useEffect(()=>{if(!l?.sorteo_date)return;const r=new Date(l.sorteo_date),a=setInterval(()=>{const o=r-new Date;if(o<=0)return clearInterval(a),b({days:0,hours:0,mins:0,secs:0});const s=Math.floor(o/864e5),n=Math.floor(o/36e5%24),t=Math.floor(o/6e4%60),g=Math.floor(o/1e3%60);b({days:s,hours:n,mins:t,secs:g})},1e3);return()=>clearInterval(a)},[l]),d.useEffect(()=>{C()},[]);const h=r=>{const{name:a,value:o,type:s,checked:n}=r.target;j(t=>({...t,[a]:s==="checkbox"?n:o}))},S=async r=>{try{const a=await C(),o={...P,numeroPedido:u?.purchaseNumber||"NO_DISPONIBLE",fechaHoraPedido:new Date().toISOString(),descripcionDenegacion:r.errorMessage||r.message||"Error en proceso de pago",ipUsuario:a,usuarioDni:i.dni,usuarioNombres:i.nombres,usuarioApellidos:i.apellidos,usuarioTelefono:i.telefono,sessionKey:u?.sessionKey?.substring(0,10)+"..."||"NO_DISPONIBLE",merchantId:u?.merchantId||"NO_DISPONIBLE",amount:u?.amount||"NO_DISPONIBLE",errorCode:r.errorCode||"UNKNOWN",timestamp:Date.now(),userAgent:navigator.userAgent};console.log("üíæ Guardando datos de denuncia:",o);const s=await fetch(f.libroReclamaciones,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({tipo:"DENUNCIA_PAGO",datos:o,estado:"PENDIENTE"})});if(s.ok){const n=await s.json();return console.log("‚úÖ Denuncia guardada exitosamente:",n),n}else return console.error("‚ùå Error guardando denuncia:",s.status),null}catch(a){return console.error("‚ùå Error en guardarDenuncia:",a),null}},C=async()=>{try{const r=["https://api.ipify.org?format=json","https://ipapi.co/json/","https://httpbin.org/ip"];for(const o of r)try{const n=await(await fetch(o)).json(),t=n.ip||n.origin||n.query;if(t)return console.log("üåê IP obtenida:",t),y(g=>({...g,ipUsuario:t})),t}catch(s){console.warn(`‚ö†Ô∏è Error obteniendo IP de ${o}:`,s);continue}console.warn("‚ö†Ô∏è No se pudo obtener IP externa, usando fallback");const a="IP_NO_DISPONIBLE";return y(o=>({...o,ipUsuario:a})),a}catch(r){return console.error("‚ùå Error general obteniendo IP:",r),y(a=>({...a,ipUsuario:"ERROR_IP"})),"ERROR_IP"}},v=async r=>{if(r.preventDefault(),c(""),console.log("[UI] submit"),!i.mayorEdad)return alert("Debes confirmar que eres mayor de edad.");try{p(!0),console.log("[API] POST niubiz/session - Bot√≥n de Pago Web");const a=await fetch(f.niubizSession,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({amount:l?.ticket_price??15,currency:"PEN",customer:{dni:i.dni,email:`${i.dni}@gameztore.com`,telefono:i.telefono,ciudad:i.departamento||"Lima",direccion:"Av Jose Pardo 831",codigoPostal:"15074"}})}),o=await a.text();let s={};try{s=JSON.parse(o)}catch{}if(console.log("[API] status",a.status,"body:",s||o),!a.ok){c(s?.error||`Error create (${a.status})`),p(!1);return}if(!s?.sessionKey&&!s?.testMode){c("Respuesta inesperada de create (sin sessionKey)"),p(!1);return}if(s.testMode&&!s.sessionKey){console.log("üß™ MODO DE PRUEBA ACTIVADO - Sin credenciales reales de Niubiz"),m({purchaseNumber:Date.now().toString().slice(-10),transactionId:`TEST-${Date.now()}`,testMode:!0,sessionData:s,reason:"Credenciales de test"}),setTimeout(()=>{console.log("üé≠ Simulando autorizaci√≥n autom√°tica..."),w(`TEST-${Date.now()}`,Date.now().toString().slice(-10))},4e3);return}if(s.sessionKey){console.log("‚úÖ SessionKey real obtenida, intentando checkout real de Niubiz");try{await O();const n=Date.now().toString().slice(-10);m({sessionKey:s.sessionKey,merchantId:s.merchantId,purchaseNumber:n,amount:s.amount,expirationTime:s.expirationTime}),T(s,n)}catch(n){console.error("‚ùå Error cargando librer√≠a de Niubiz:",n),c("No se pudo cargar el checkout de Niubiz. Verifique que est√© en HTTPS o contacte soporte."),p(!1);return}return}}catch(a){console.error("[API] create error",a),c(a.message||"Error iniciando el pago")}finally{p(!1)}},O=()=>new Promise((r,a)=>{const o="https://static-content-qas.vnforapps.com/env/sandbox/js/checkout.js";if(console.log("üì¶ Cargando script oficial de Niubiz:",o),window.VisanetCheckout&&typeof window.VisanetCheckout.configure=="function"){console.log("‚úÖ VisanetCheckout ya est√° cargado"),r();return}document.querySelectorAll('script[src*="checkout"], script[src*="payform"], script[src*="vnforapps"]').forEach(t=>{t.remove(),console.log("üßπ Script anterior eliminado:",t.src)});const n=document.createElement("script");n.src=o,n.async=!0,n.onload=()=>{console.log(`‚úÖ Script cargado desde: ${o}`),setTimeout(()=>{window.VisanetCheckout&&typeof window.VisanetCheckout.configure=="function"?(console.log("‚úÖ window.VisanetCheckout disponible"),r()):(console.error("‚ùå window.VisanetCheckout no disponible despu√©s de la carga"),a(new Error("VisanetCheckout no disponible despu√©s de cargar la librer√≠a")))},1e3)},n.onerror=t=>{console.error(`‚ùå Error cargando desde ${o}:`,t),a(new Error(`Error cargando librer√≠a de Niubiz desde ${o}`))},document.head.appendChild(n),setTimeout(()=>{window.VisanetCheckout||(console.error("‚è∞ Timeout cargando librer√≠a de Niubiz"),a(new Error("Timeout cargando librer√≠a de Niubiz")))},1e4)}),T=(r,a)=>{console.log("üîß Configurando Niubiz Checkout...");try{if(!window.VisanetCheckout)throw new Error("VisanetCheckout no est√° disponible");if(typeof window.VisanetCheckout.configure!="function")throw new Error("VisanetCheckout.configure no es una funci√≥n");const o={action:"pay",merchantid:r.merchantId,sessiontoken:r.sessionKey,purchasenumber:a,amount:parseFloat(r.amount),currency:"PEN",channel:"web",expirationminutes:15,timeouturl:"https://anapse.github.io/app-webpremios/#/niubiz"};if(!/^\d+$/.test(a))throw new Error("purchaseNumber debe contener solo n√∫meros");if(a.length>12)throw new Error("purchaseNumber no puede tener m√°s de 12 d√≠gitos");if(isNaN(o.amount)||o.amount<=0)throw new Error("amount debe ser un n√∫mero positivo");console.log("üìã Validando par√°metros obligatorios:"),console.log("  action:",o.action,"(obligatorio)"),console.log("  merchantid:",o.merchantid,"(obligatorio)"),console.log("  sessiontoken:",o.sessiontoken?`${o.sessiontoken.substring(0,10)}...`:"MISSING","(obligatorio)"),console.log("  purchasenumber:",o.purchasenumber,`(obligatorio, longitud: ${o.purchasenumber.length})`),console.log("  amount:",o.amount,`(obligatorio, tipo: ${typeof o.amount})`),console.log("  timeouturl:",o.timeouturl,"(obligatorio)"),console.log("  currency:",o.currency),console.log("  channel:",o.channel),console.log("  expirationminutes:",o.expirationminutes);const s=["action","merchantid","sessiontoken","purchasenumber","amount","timeouturl"];for(const n of s)if(!o[n]||o[n]===void 0||o[n]==="")throw new Error(`Par√°metro obligatorio faltante o vac√≠o: ${n}`);console.log("‚úÖ Todos los par√°metros obligatorios est√°n presentes"),window.VisanetCheckout.configure({...o,complete:function(n){console.log("‚úÖ Checkout completado desde Niubiz:",n),p(!1);const t=n?.transactionToken||n?.tokenId;if(!t){console.error("‚ùå No se recibi√≥ token del checkout de Niubiz"),c("No se recibi√≥ token de transacci√≥n del checkout. Intente nuevamente."),m(null);return}console.log("üîë Token real recibido:",t),w(t,a)},error:function(n){console.error("‚ùå Error en el pago desde Niubiz:",n),S(n).then(t=>{t&&console.log("üìã Denuncia registrada autom√°ticamente por error de pago")}),c(`Error en el proceso de pago: ${n.errorMessage||n.message||"Intenta nuevamente"}`),m(null),p(!1)},close:function(){console.log("‚ÑπÔ∏è Checkout cerrado por el usuario"),m(null),p(!1)}}),console.log("‚úÖ VisanetCheckout.configure() ejecutado exitosamente"),console.log("üì± Abriendo checkout real de Niubiz..."),setTimeout(()=>{try{window.VisanetCheckout.open(),console.log("‚úÖ VisanetCheckout.open() ejecutado")}catch(n){console.error("‚ùå Error al abrir checkout:",n),c(`Error al abrir el checkout: ${n.message}`),p(!1)}},100)}catch(o){console.error("‚ùå Error configurando checkout:",o),c(`Error inicializando el checkout de Niubiz: ${o.message}`),m(null),p(!1)}},w=async(r,a)=>{try{console.log("üîê Autorizando transacci√≥n con token REAL..."),console.log("üìù Datos de autorizaci√≥n:",{transactionToken:r,purchaseNumber:a,amount:l?.ticket_price??15});const s=await(await fetch(f.niubizConfirm,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({tokenId:r,purchaseNumber:a,amount:l?.ticket_price??15,currency:"PEN"})})).json();console.log("‚úÖ Respuesta de autorizaci√≥n:",s);const n=s?.dataMap?.ACTION_CODE||s?.actionCode;if(s?.testMode||n==="000"){console.log("üéâ Pago APROBADO con c√≥digo:",n);const t=await fetch(f.tickets,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({...i,token_yape:s.dataMap?.TRANSACTION_ID||r,id_transaccion:s.dataMap?.TRANSACTION_ID||r,estado_pago:"pagado"})}),g=await t.json().catch(()=>({}));console.log("[TICKET] status",t.status,g),t.ok?(D(g.codigo_ticket),m(null)):c(g?.error||"No se pudo registrar el ticket")}else{console.error("‚ùå Pago RECHAZADO con c√≥digo:",n);const t={errorCode:n,message:`Pago rechazado con c√≥digo: ${n}`,errorMessage:`La transacci√≥n fue rechazada por el sistema de pagos (ACTION_CODE: ${n})`};S(t).then(g=>{g&&console.log("üìã Denuncia registrada por pago rechazado")}),c(`Pago no autorizado (c√≥digo: ${n}). Intenta nuevamente.`),m(null)}}catch(o){console.error("‚ùå Error en autorizaci√≥n:",o),c("Error procesando el pago. Intenta nuevamente."),m(null)}},z=()=>{const r=new R;r.setFontSize(16),r.text("üé´ Ticket Game Ztore",20,30),r.setFontSize(12),r.text(`Nombre: ${i.nombres} ${i.apellidos}`,20,45),r.text(`DNI: ${i.dni}`,20,55),r.text(`Tel√©fono: ${i.telefono}`,20,65),r.text(`Departamento: ${i.departamento}`,20,75),r.text(`C√≥digo de Ticket: ${x}`,20,85),r.text(`Fecha: ${new Date().toLocaleDateString()}`,20,95),r.save(`${x}.pdf`)};return e.jsx("section",{className:"registro-form",children:e.jsxs("div",{className:"form-container",children:[e.jsx("h2",{children:"Registro de Ticket"}),u?.testMode&&e.jsxs("div",{style:{background:"linear-gradient(135deg, #ff7e00 0%, #e06f00 100%)",border:"2px solid #ff7e00",borderRadius:"12px",padding:"15px",marginBottom:"20px",color:"#1f1f1d",fontWeight:"bold"},children:[e.jsx("strong",{children:"üß™ MODO DE PRUEBA NIUBIZ"}),u.fallbackMode&&e.jsxs(e.Fragment,{children:[e.jsx("br",{}),e.jsx("strong",{children:"‚ö†Ô∏è MODO FALLBACK"})]}),e.jsx("br",{}),e.jsx("small",{style:{color:"#1f1f1d",opacity:"0.8"},children:u.reason==="Credenciales de test"?"Simulaci√≥n de pago - Configurar credenciales reales para checkout verdadero":u.fallbackMode?"Simulaci√≥n por error de librer√≠a - Verificar conectividad":"Modo de prueba activo"})]}),E&&e.jsx("div",{className:"error",style:{marginBottom:10,color:"#ff6b6b"},children:E}),x?e.jsxs("div",{className:"resultado-ticket",children:[e.jsx("p",{children:"üéâ ¬°Gracias por tu compra!"}),e.jsx("p",{children:"Tu n√∫mero de ticket es:"}),e.jsx("h3",{children:x}),e.jsx("button",{onClick:z,children:"Descargar ticket en PDF"})]}):u?e.jsx("div",{className:"pago-niubiz",children:u.testMode?e.jsxs(e.Fragment,{children:[e.jsxs("p",{children:["üß™ ",e.jsx("strong",{children:"MODO DE PRUEBA NIUBIZ - MEJORADO"})]}),e.jsx("p",{children:"Simulando proceso de pago con Niubiz Sandbox"}),e.jsxs("div",{className:"niubiz-mock-container processing",children:[e.jsx("div",{className:"test-mode-badge",children:"TEST"}),e.jsxs("div",{className:"niubiz-mock-content",children:[e.jsx("div",{className:"icon",children:"üí≥"}),e.jsx("div",{className:"title",children:"Bot√≥n de Pago Web"}),e.jsx("div",{className:"subtitle",children:"Niubiz Sandbox - Incluye Yape"})]})]}),e.jsxs("div",{className:"payment-status",children:[e.jsxs("p",{children:[e.jsx("span",{className:"loading-spinner"}),"Procesando pago autom√°ticamente..."]}),e.jsx("p",{className:"timer",children:"‚è±Ô∏è Aprobaci√≥n en 4 segundos"}),e.jsx("p",{className:"info-text",children:"üí° En producci√≥n (HTTPS) se abrir√° el formulario web real de Niubiz con Yape"})]})]}):e.jsxs("div",{className:"niubiz-processing",children:[e.jsxs("p",{children:["üí≥ ",e.jsx("strong",{children:"PROCESANDO PAGO CON NIUBIZ"})]}),e.jsx("p",{children:"Se ha abierto el formulario de pago seguro de Niubiz"}),e.jsxs("div",{className:"payment-status",children:[e.jsxs("p",{children:[e.jsx("span",{className:"loading-spinner"}),"Esperando confirmaci√≥n..."]}),e.jsx("p",{style:{fontSize:"14px",opacity:"0.8"},children:"Complete el pago en la ventana emergente de Niubiz"}),e.jsx("p",{style:{fontSize:"12px",opacity:"0.6"},children:"üí≥ M√©todos disponibles: Tarjetas Visa/MasterCard, Yape"})]})]})}):e.jsxs("form",{onSubmit:v,children:[e.jsx("input",{name:"dni",placeholder:"DNI o C. de Extranjer√≠a",value:i.dni,onChange:h,required:!0}),e.jsx("input",{name:"nombres",placeholder:"Nombres",value:i.nombres,onChange:h,required:!0}),e.jsx("input",{name:"apellidos",placeholder:"Apellidos",value:i.apellidos,onChange:h,required:!0}),e.jsx("input",{name:"telefono",placeholder:"N√∫mero WhatsApp",value:i.telefono,onChange:h,required:!0}),e.jsxs("select",{name:"departamento",value:i.departamento,onChange:h,required:!0,children:[e.jsx("option",{value:"",children:"Selecciona Departamento"}),A.map(r=>e.jsx("option",{value:r,children:r},r))]}),e.jsxs("label",{className:"checkbox-label",children:[e.jsx("input",{type:"checkbox",name:"mayorEdad",checked:i.mayorEdad,onChange:h}),"Confirmo que soy mayor de edad"]}),e.jsx("button",{type:"submit",className:"btn-yape",disabled:k,children:k?"Iniciando pago seguro...":"Pagar con Niubiz (incluye Yape)"})]}),e.jsx("div",{className:"contador",children:["days","hours","mins","secs"].map(r=>e.jsxs("div",{className:"unidad",children:[e.jsx("div",{className:"numero",children:String(N[r]).padStart(2,"0")}),e.jsx("div",{className:"texto",children:r==="days"?"D√≠as":r==="hours"?"Horas":r==="mins"?"Minutos":"Segundos"})]},r))})]})})},q=()=>e.jsxs("main",{className:"registro-page",children:[e.jsx(M,{}),e.jsx($,{})]});export{q as default};
