import{a as x,j as e}from"./index-DAMTjNNs.js";import{b as p}from"./vendor-DJKrsZSW.js";import{d as I}from"./RegistroInfo-CLtfe4US.js";import{u as S}from"./useFetch-B8Cb0pGo.js";import{E as P}from"./pdf-C1-dEYVs.js";const D=()=>{const{data:c,loading:j,error:f}=S(x.proximoSorteo),[t,N]=p.useState(null);return p.useEffect(()=>{c&&c.ticket_price!==void 0&&N(c.ticket_price)},[c]),e.jsxs("section",{className:"registro-info",children:[e.jsx("h2",{children:"Â¿CÃ³mo Participar?"}),e.jsxs("p",{className:"paso",children:["ðŸ“ ",e.jsx("strong",{children:"PASO 1:"})," Completa tus datos en el formulario de abajo (DNI o Carnet de ExtranjerÃ­a)."]}),e.jsxs("p",{className:"paso",children:["ðŸ’³ ",e.jsx("strong",{children:"PASO 2:"})," Haz clic en ",e.jsx("strong",{children:"Registrar Ticket"})," para iniciar el proceso de pago seguro con Niubiz."]}),e.jsxs("p",{className:"detalle",children:["ï¿½ Se generarÃ¡ un ",e.jsx("strong",{children:"cÃ³digo QR de Yape"})," que debes escanear con tu app Yape para completar el pago."]}),e.jsxs("p",{className:"paso",children:["ðŸŽ« ",e.jsx("strong",{children:"PASO 3:"})," Una vez confirmado el pago, tu ticket se generarÃ¡ automÃ¡ticamente."]}),e.jsxs("div",{className:"detalle",children:[e.jsxs("p",{children:["âœ… VerÃ¡s tu ",e.jsx("strong",{children:"cÃ³digo de ticket Ãºnico"})," en pantalla."]}),e.jsxs("p",{children:["ðŸ“„ PodrÃ¡s ",e.jsx("strong",{children:"descargarlo como PDF"})," para conservarlo."]}),e.jsxs("p",{children:["ðŸ” TambiÃ©n podrÃ¡s ",e.jsx("strong",{children:"buscar tus tickets"}),' en la secciÃ³n "Mis Tickets".']})]}),e.jsx("p",{className:"costo",children:"ðŸŽŸï¸ Costo del ticket"}),e.jsx("p",{className:"precio",children:e.jsx("strong",{children:j?"Cargando...":f?"Error al cargar":`S/ ${t}`})}),e.jsx("p",{className:"paso2",children:"ðŸŽ‰ Â¡Ya estarÃ¡s participando en el prÃ³ximo sorteo!"}),e.jsx("div",{className:"flecha",children:e.jsx("strong",{children:"ðŸ‘‡"})})]})},O=()=>{const{data:c}=S(x.proximoSorteo),[j,f]=p.useState({days:0,hours:0,mins:0,secs:0}),[t,N]=p.useState({dni:"",nombres:"",apellidos:"",telefono:"",departamento:"",mayorEdad:!1}),[b,E]=p.useState(null),[m,d]=p.useState(null),[y,u]=p.useState(!1),[k,l]=p.useState("");p.useEffect(()=>{if(!c?.sorteo_date)return;const o=new Date(c.sorteo_date),n=setInterval(()=>{const r=o-new Date;if(r<=0)return clearInterval(n),f({days:0,hours:0,mins:0,secs:0});const s=Math.floor(r/864e5),a=Math.floor(r/36e5%24),i=Math.floor(r/6e4%60),g=Math.floor(r/1e3%60);f({days:s,hours:a,mins:i,secs:g})},1e3);return()=>clearInterval(n)},[c]);const h=o=>{const{name:n,value:r,type:s,checked:a}=o.target;N(i=>({...i,[n]:s==="checkbox"?a:r}))},v=async o=>{if(o.preventDefault(),l(""),console.log("[UI] submit"),!t.mayorEdad)return alert("Debes confirmar que eres mayor de edad.");try{u(!0),console.log("[API] POST niubiz/session - BotÃ³n de Pago Web");const n=await fetch(x.niubizSession,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({amount:c?.ticket_price??15,currency:"PEN",customer:{dni:t.dni,email:`${t.dni}@gameztore.com`,telefono:t.telefono,ciudad:t.departamento||"Lima",direccion:"Av Jose Pardo 831",codigoPostal:"15074"}})}),r=await n.text();let s={};try{s=JSON.parse(r)}catch{}if(console.log("[API] status",n.status,"body:",s||r),!n.ok){l(s?.error||`Error create (${n.status})`),u(!1);return}if(!s?.sessionKey&&!s?.testMode){l("Respuesta inesperada de create (sin sessionKey)"),u(!1);return}if(s.testMode&&!s.sessionKey){console.log("ðŸ§ª MODO DE PRUEBA ACTIVADO - Sin credenciales reales de Niubiz"),d({purchaseNumber:Date.now().toString().slice(-10),transactionId:`TEST-${Date.now()}`,testMode:!0,sessionData:s,reason:"Credenciales de test"}),setTimeout(()=>{console.log("ðŸŽ­ Simulando autorizaciÃ³n automÃ¡tica..."),C(`TEST-${Date.now()}`,Date.now().toString().slice(-10))},4e3);return}if(s.sessionKey){console.log("âœ… SessionKey real obtenida, intentando checkout real de Niubiz");try{await z(s.checkoutUrl);const a=Date.now().toString().slice(-10);d({sessionKey:s.sessionKey,merchantId:s.merchantId,purchaseNumber:a,amount:s.amount,expirationTime:s.expirationTime}),w(s,a)}catch(a){console.error("âŒ Error cargando librerÃ­a de Niubiz:",a),l("No se pudo cargar el checkout de Niubiz. Verifique que estÃ© en HTTPS o contacte soporte."),u(!1);return}return}}catch(n){console.error("[API] create error",n),l(n.message||"Error iniciando el pago")}finally{u(!1)}},z=o=>new Promise((n,r)=>{if(console.log("ðŸ“¦ Cargando librerÃ­a oficial de Niubiz:",o),window.VisanetCheckout&&typeof window.VisanetCheckout.configure=="function"){console.log("âœ… VisanetCheckout ya estÃ¡ cargado"),n();return}document.querySelectorAll('script[src*="checkout"], script[src*="payform"], script[src*="vnforapps"]').forEach(i=>{i.remove(),console.log("ðŸ§¹ Script anterior eliminado:",i.src)});const a=document.createElement("script");a.src=o,a.async=!0,a.crossOrigin="anonymous",a.onload=()=>{console.log(`âœ… Script cargado desde: ${o}`),setTimeout(()=>{window.VisanetCheckout&&typeof window.VisanetCheckout.configure=="function"?(console.log("âœ… VisanetCheckout.configure disponible"),n()):(console.error("âŒ VisanetCheckout no disponible despuÃ©s de la carga"),r(new Error("VisanetCheckout no disponible despuÃ©s de cargar la librerÃ­a")))},1e3)},a.onerror=i=>{console.error(`âŒ Error cargando desde ${o}:`,i),r(new Error(`Error cargando librerÃ­a de Niubiz desde ${o}`))},document.head.appendChild(a),setTimeout(()=>{window.VisanetCheckout||(console.error("â° Timeout cargando librerÃ­a de Niubiz"),r(new Error("Timeout cargando librerÃ­a de Niubiz")))},1e4)}),w=(o,n)=>{console.log("ðŸ”§ Configurando Niubiz Checkout con datos:",{sessionKey:o.sessionKey,merchantId:o.merchantId,purchaseNumber:n,amount:o.amount});try{if(!window.VisanetCheckout)throw new Error("VisanetCheckout no estÃ¡ disponible");if(typeof window.VisanetCheckout.configure!="function")throw new Error("VisanetCheckout.configure no es una funciÃ³n");window.VisanetCheckout.configure({sessiontoken:o.sessionKey,channel:"web",merchantid:o.merchantId,purchasenumber:n,amount:o.amount,currency:"PEN",expirationminutes:15,complete:function(r){console.log("âœ… Checkout completado desde Niubiz:",r),u(!1);const s=r?.transactionToken||r?.tokenId;if(!s){console.error("âŒ No se recibiÃ³ token del checkout de Niubiz"),l("No se recibiÃ³ token de transacciÃ³n del checkout. Intente nuevamente."),d(null);return}console.log("ðŸ”‘ Token real recibido:",s),C(s,n)},error:function(r){console.error("âŒ Error en el pago desde Niubiz:",r),l(`Error en el proceso de pago: ${r.errorMessage||r.message||"Intenta nuevamente"}`),d(null),u(!1)},close:function(){console.log("â„¹ï¸ Checkout cerrado por el usuario"),d(null),u(!1)}}),console.log("ðŸ“± Abriendo checkout real de Niubiz..."),window.VisanetCheckout.open()}catch(r){console.error("âŒ Error configurando checkout:",r),l(`Error inicializando el checkout de Niubiz: ${r.message}`),d(null),u(!1)}},C=async(o,n)=>{try{console.log("ðŸ” Autorizando transacciÃ³n con token REAL..."),console.log("ðŸ“ Datos de autorizaciÃ³n:",{transactionToken:o,purchaseNumber:n,amount:c?.ticket_price??15});const s=await(await fetch(x.niubizConfirm,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({transactionToken:o,purchaseNumber:n,amount:c?.ticket_price??15})})).json();console.log("âœ… Respuesta de autorizaciÃ³n:",s);const a=s?.dataMap?.ACTION_CODE||s?.actionCode;if(s?.testMode||a==="000"){console.log("ðŸŽ‰ Pago APROBADO con cÃ³digo:",a);const i=await fetch(x.tickets,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({...t,token_yape:s.dataMap?.TRANSACTION_ID||o,id_transaccion:s.dataMap?.TRANSACTION_ID||o,estado_pago:"pagado"})}),g=await i.json().catch(()=>({}));console.log("[TICKET] status",i.status,g),i.ok?(E(g.codigo_ticket),d(null)):l(g?.error||"No se pudo registrar el ticket")}else console.error("âŒ Pago RECHAZADO con cÃ³digo:",a),l(`Pago no autorizado (cÃ³digo: ${a}). Intenta nuevamente.`),d(null)}catch(r){console.error("âŒ Error en autorizaciÃ³n:",r),l("Error procesando el pago. Intenta nuevamente."),d(null)}},T=()=>{const o=new P;o.setFontSize(16),o.text("ðŸŽ« Ticket Game Ztore",20,30),o.setFontSize(12),o.text(`Nombre: ${t.nombres} ${t.apellidos}`,20,45),o.text(`DNI: ${t.dni}`,20,55),o.text(`TelÃ©fono: ${t.telefono}`,20,65),o.text(`Departamento: ${t.departamento}`,20,75),o.text(`CÃ³digo de Ticket: ${b}`,20,85),o.text(`Fecha: ${new Date().toLocaleDateString()}`,20,95),o.save(`${b}.pdf`)};return e.jsx("section",{className:"registro-form",children:e.jsxs("div",{className:"form-container",children:[e.jsx("h2",{children:"Registro de Ticket"}),m?.testMode&&e.jsxs("div",{style:{background:"linear-gradient(135deg, #ff7e00 0%, #e06f00 100%)",border:"2px solid #ff7e00",borderRadius:"12px",padding:"15px",marginBottom:"20px",color:"#1f1f1d",fontWeight:"bold"},children:[e.jsx("strong",{children:"ðŸ§ª MODO DE PRUEBA NIUBIZ"}),m.fallbackMode&&e.jsxs(e.Fragment,{children:[e.jsx("br",{}),e.jsx("strong",{children:"âš ï¸ MODO FALLBACK"})]}),e.jsx("br",{}),e.jsx("small",{style:{color:"#1f1f1d",opacity:"0.8"},children:m.reason==="Credenciales de test"?"SimulaciÃ³n de pago - Configurar credenciales reales para checkout verdadero":m.fallbackMode?"SimulaciÃ³n por error de librerÃ­a - Verificar conectividad":"Modo de prueba activo"})]}),k&&e.jsx("div",{className:"error",style:{marginBottom:10,color:"#ff6b6b"},children:k}),b?e.jsxs("div",{className:"resultado-ticket",children:[e.jsx("p",{children:"ðŸŽ‰ Â¡Gracias por tu compra!"}),e.jsx("p",{children:"Tu nÃºmero de ticket es:"}),e.jsx("h3",{children:b}),e.jsx("button",{onClick:T,children:"Descargar ticket en PDF"})]}):m?e.jsx("div",{className:"pago-niubiz",children:m.testMode?e.jsxs(e.Fragment,{children:[e.jsxs("p",{children:["ðŸ§ª ",e.jsx("strong",{children:"MODO DE PRUEBA NIUBIZ - MEJORADO"})]}),e.jsx("p",{children:"Simulando proceso de pago con Niubiz Sandbox"}),e.jsxs("div",{className:"niubiz-mock-container processing",children:[e.jsx("div",{className:"test-mode-badge",children:"TEST"}),e.jsxs("div",{className:"niubiz-mock-content",children:[e.jsx("div",{className:"icon",children:"ðŸ’³"}),e.jsx("div",{className:"title",children:"BotÃ³n de Pago Web"}),e.jsx("div",{className:"subtitle",children:"Niubiz Sandbox - Incluye Yape"})]})]}),e.jsxs("div",{className:"payment-status",children:[e.jsxs("p",{children:[e.jsx("span",{className:"loading-spinner"}),"Procesando pago automÃ¡ticamente..."]}),e.jsx("p",{className:"timer",children:"â±ï¸ AprobaciÃ³n en 4 segundos"}),e.jsx("p",{className:"info-text",children:"ðŸ’¡ En producciÃ³n (HTTPS) se abrirÃ¡ el formulario web real de Niubiz con Yape"})]})]}):e.jsxs("div",{className:"niubiz-processing",children:[e.jsxs("p",{children:["ðŸ’³ ",e.jsx("strong",{children:"PROCESANDO PAGO CON NIUBIZ"})]}),e.jsx("p",{children:"Se ha abierto el formulario de pago seguro de Niubiz"}),e.jsxs("div",{className:"payment-status",children:[e.jsxs("p",{children:[e.jsx("span",{className:"loading-spinner"}),"Esperando confirmaciÃ³n..."]}),e.jsx("p",{style:{fontSize:"14px",opacity:"0.8"},children:"Complete el pago en la ventana emergente de Niubiz"}),e.jsx("p",{style:{fontSize:"12px",opacity:"0.6"},children:"ðŸ’³ MÃ©todos disponibles: Tarjetas Visa/MasterCard, Yape"})]})]})}):e.jsxs("form",{onSubmit:v,children:[e.jsx("input",{name:"dni",placeholder:"DNI o C. de ExtranjerÃ­a",value:t.dni,onChange:h,required:!0}),e.jsx("input",{name:"nombres",placeholder:"Nombres",value:t.nombres,onChange:h,required:!0}),e.jsx("input",{name:"apellidos",placeholder:"Apellidos",value:t.apellidos,onChange:h,required:!0}),e.jsx("input",{name:"telefono",placeholder:"NÃºmero WhatsApp",value:t.telefono,onChange:h,required:!0}),e.jsxs("select",{name:"departamento",value:t.departamento,onChange:h,required:!0,children:[e.jsx("option",{value:"",children:"Selecciona Departamento"}),I.map(o=>e.jsx("option",{value:o,children:o},o))]}),e.jsxs("label",{className:"checkbox-label",children:[e.jsx("input",{type:"checkbox",name:"mayorEdad",checked:t.mayorEdad,onChange:h}),"Confirmo que soy mayor de edad"]}),e.jsx("button",{type:"submit",className:"btn-yape",disabled:y,children:y?"Iniciando pago seguro...":"Pagar con Niubiz (incluye Yape)"})]}),e.jsx("div",{className:"contador",children:["days","hours","mins","secs"].map(o=>e.jsxs("div",{className:"unidad",children:[e.jsx("div",{className:"numero",children:String(j[o]).padStart(2,"0")}),e.jsx("div",{className:"texto",children:o==="days"?"DÃ­as":o==="hours"?"Horas":o==="mins"?"Minutos":"Segundos"})]},o))})]})})},_=()=>e.jsxs("main",{className:"registro-page",children:[e.jsx(D,{}),e.jsx(O,{})]});export{_ as default};
